<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src https://cdn.jsdelivr.net;">
  <title>LocalLM Agent</title>
  <!-- KaTeX for LaTeX rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
  <!-- Highlight.js for code syntax highlighting - using full bundle with common languages -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>LocalLM</h1>
      </div>
      
      <div class="sidebar-section model-select-section">
        <label for="model-selector-btn">Model</label>
        <button id="model-selector-btn" class="model-selector-btn" type="button" disabled>
          <div class="model-selector-text">
            <div id="model-selector-title" class="model-selector-title">Loading models...</div>
            <div id="model-selector-desc" class="model-selector-desc"></div>
          </div>
          <div class="model-selector-caret" aria-hidden="true">‚ñæ</div>
        </button>
        <div id="model-select-dropdown" class="model-select-dropdown" style="display: none;">
          <div id="model-select-list" class="model-select-list"></div>
        </div>
        <select id="model-select" class="model-select-hidden" disabled aria-hidden="true" tabindex="-1">
          <option value="">Loading models...</option>
        </select>
      </div>

      <div class="sidebar-section new-chat-section">
        <button id="new-chat-btn" class="btn btn-primary">New Chat</button>
      </div>

      <div class="sidebar-section chat-list-section">
        <div class="chat-list-header">
          <h3>Conversations</h3>
          <button id="clear-all-chats-btn" class="btn btn-icon btn-small" title="Clear all chats">üóëÔ∏è</button>
        </div>
        <div id="chat-list" class="chat-list">
          <!-- Chat items will be inserted here -->
        </div>
      </div>

      <div class="sidebar-section status-section">
        <div id="ollama-status" class="status status-checking">
          <span class="status-dot"></span>
          <span class="status-text">Checking Ollama...</span>
        </div>
        <div class="model-status-row">
          <div id="model-status" class="status status-unloaded">
            <span class="status-dot"></span>
            <span class="status-text">Model not loaded</span>
          </div>
          <button id="unload-model-btn" class="btn btn-icon btn-small btn-danger" title="Unload model from VRAM" style="display: none;">‚èèÔ∏è</button>
        </div>
      </div>

      <div class="sidebar-section model-info-section" id="model-info-section" style="display: none;">
        <h3>Model Info</h3>
        <div id="model-info-content"></div>
      </div>

      <div class="sidebar-footer">
        <button id="settings-btn" class="btn btn-icon" title="Settings">‚öôÔ∏è</button>
        <button id="help-btn" class="btn btn-icon" title="Help">‚ùì</button>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-container">
      <!-- Messages -->
      <div class="messages-wrapper">
        <div id="messages" class="messages">
          <div class="welcome-message">
            <h2>Welcome to LocalLM Agent</h2>
            <p>Select a model and start chatting with your local AI.</p>
            <div id="no-models-warning" class="warning-box" style="display: none;">
              <h3>‚ö†Ô∏è No Models Found</h3>
              <p>You need to install at least one model to start chatting.</p>
              <p>Open a terminal and run:</p>
              <code>ollama pull llama3.2</code>
              <p>Then click "Refresh" to reload the model list.</p>
              <button id="refresh-models-btn" class="btn btn-secondary">üîÑ Refresh Models</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="input-container">
        <!-- Attachment Preview Area -->
        <div id="attachment-preview" class="attachment-preview" style="display: none;">
          <div id="attachment-list" class="attachment-list"></div>
        </div>
        <div class="input-row">
          <div class="input-wrapper">
            <div class="input-left-actions">
              <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
            </div>
            <textarea 
              id="chat-input" 
              placeholder="Type your message... (Shift+Enter for new line)"
              rows="1"
              disabled
            ></textarea>
            <div class="input-actions">
              <button id="stop-btn" class="btn btn-icon" title="Stop generation" style="display: none;">‚èπÔ∏è</button>
            </div>
          </div>
          <button id="send-btn" class="btn btn-primary" disabled>
            <span id="send-icon">‚û§</span>
            <span id="loading-icon" class="loading-spinner" style="display: none;"></span>
          </button>
        </div>
        <div class="input-footer">
          <span id="char-count">0</span>&nbsp;characters
          <span class="separator">|</span>
          <span id="generation-stats"></span>
          <span id="vision-indicator" class="vision-indicator" style="display: none;">Vision enabled</span>
        </div>
      </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display: none;">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>‚öôÔ∏è Model Settings</h2>
          <button class="modal-close" id="close-settings-modal">&times;</button>
        </div>
        <div class="modal-body">
          <p class="settings-description">Adjust parameters to control model behavior. Hover over labels for descriptions.</p>
          
          <!-- Think Mode Toggle - prominent at top -->
          <div class="setting-item setting-item-toggle">
            <label for="setting-think" title="Enable thinking/reasoning mode for compatible models (DeepSeek R1, Qwen3, etc.)">
              <span class="toggle-label">
                Think Mode
                <span class="setting-hint-inline">For reasoning models</span>
              </span>
            </label>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" id="setting-think">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-grid">
            <!-- Temperature -->
            <div class="setting-item">
              <label for="setting-temperature" title="Controls randomness. Lower = more focused, Higher = more creative">
                Temperature
                <span class="setting-range">(0.0 - 2.0)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-temperature" min="0" max="2" step="0.1" value="0.8">
                <input type="number" id="setting-temperature-value" min="0" max="2" step="0.1" value="0.8">
              </div>
              <p class="setting-hint">Default: 0.8 | Lower = deterministic, Higher = creative</p>
            </div>

            <!-- Context Window -->
            <div class="setting-item">
              <label for="setting-num-ctx" title="Maximum number of tokens in the context window">
                Context Window
                <span class="setting-range">(512 - 131072)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-num-ctx" min="512" max="131072" step="512" value="4096">
                <input type="number" id="setting-num-ctx-value" min="512" max="131072" step="512" value="4096">
              </div>
              <p class="setting-hint">Default: 2048 | Higher = more memory, slower generation</p>
            </div>

            <!-- Max Tokens (num_predict) -->
            <div class="setting-item">
              <label for="setting-num-predict" title="Maximum tokens to generate. -1 for unlimited">
                Max Tokens
                <span class="setting-range">(-1 - 16384)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-num-predict" min="-1" max="16384" step="1" value="-1">
                <input type="number" id="setting-num-predict-value" min="-1" max="16384" step="1" value="-1">
              </div>
              <p class="setting-hint">Default: -1 (unlimited) | Limits response length</p>
            </div>

            <!-- Top P -->
            <div class="setting-item">
              <label for="setting-top-p" title="Nucleus sampling: only consider tokens with cumulative probability >= top_p">
                Top P
                <span class="setting-range">(0.0 - 1.0)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-top-p" min="0" max="1" step="0.05" value="0.9">
                <input type="number" id="setting-top-p-value" min="0" max="1" step="0.05" value="0.9">
              </div>
              <p class="setting-hint">Default: 0.9 | Lower = more focused responses</p>
            </div>

            <!-- Top K -->
            <div class="setting-item">
              <label for="setting-top-k" title="Limits vocabulary to top K most likely tokens">
                Top K
                <span class="setting-range">(1 - 100)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-top-k" min="1" max="100" step="1" value="40">
                <input type="number" id="setting-top-k-value" min="1" max="100" step="1" value="40">
              </div>
              <p class="setting-hint">Default: 40 | Lower = more focused, Higher = more diverse</p>
            </div>

            <!-- Repeat Penalty -->
            <div class="setting-item">
              <label for="setting-repeat-penalty" title="Penalizes repetition. Higher values reduce repetition">
                Repeat Penalty
                <span class="setting-range">(0.0 - 2.0)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-repeat-penalty" min="0" max="2" step="0.1" value="1.1">
                <input type="number" id="setting-repeat-penalty-value" min="0" max="2" step="0.1" value="1.1">
              </div>
              <p class="setting-hint">Default: 1.1 | Higher = less repetition</p>
            </div>

            <!-- Repeat Last N -->
            <div class="setting-item">
              <label for="setting-repeat-last-n" title="Number of tokens to look back for repetition penalty">
                Repeat Last N
                <span class="setting-range">(0 - 512)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-repeat-last-n" min="0" max="512" step="1" value="64">
                <input type="number" id="setting-repeat-last-n-value" min="0" max="512" step="1" value="64">
              </div>
              <p class="setting-hint">Default: 64 | 0 = disabled, -1 = context size</p>
            </div>

            <!-- Seed -->
            <div class="setting-item">
              <label for="setting-seed" title="Random seed for reproducibility. 0 = random">
                Seed
                <span class="setting-range">(0 = random)</span>
              </label>
              <div class="setting-control">
                <input type="number" id="setting-seed-value" min="0" max="999999999" step="1" value="0" style="flex: 1;">
              </div>
              <p class="setting-hint">Default: 0 (random) | Set fixed value for reproducible outputs</p>
            </div>

            <!-- Mirostat -->
            <div class="setting-item">
              <label for="setting-mirostat" title="Mirostat sampling mode for perplexity control">
                Mirostat Mode
                <span class="setting-range">(0, 1, 2)</span>
              </label>
              <div class="setting-control">
                <select id="setting-mirostat">
                  <option value="0" selected>0 - Disabled</option>
                  <option value="1">1 - Mirostat v1</option>
                  <option value="2">2 - Mirostat v2</option>
                </select>
              </div>
              <p class="setting-hint">Default: 0 | Alternative to temperature-based sampling</p>
            </div>

            <!-- Mirostat Tau -->
            <div class="setting-item">
              <label for="setting-mirostat-tau" title="Target entropy for Mirostat sampling">
                Mirostat Tau
                <span class="setting-range">(0.0 - 10.0)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-mirostat-tau" min="0" max="10" step="0.1" value="5.0">
                <input type="number" id="setting-mirostat-tau-value" min="0" max="10" step="0.1" value="5.0">
              </div>
              <p class="setting-hint">Default: 5.0 | Lower = more focused, Higher = more diverse</p>
            </div>

            <!-- Mirostat Eta -->
            <div class="setting-item">
              <label for="setting-mirostat-eta" title="Learning rate for Mirostat sampling">
                Mirostat Eta
                <span class="setting-range">(0.0 - 1.0)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-mirostat-eta" min="0" max="1" step="0.01" value="0.1">
                <input type="number" id="setting-mirostat-eta-value" min="0" max="1" step="0.01" value="0.1">
              </div>
              <p class="setting-hint">Default: 0.1 | How quickly the algorithm responds</p>
            </div>

            <!-- TFS Z -->
            <div class="setting-item">
              <label for="setting-tfs-z" title="Tail-free sampling parameter. 1.0 = disabled">
                TFS Z
                <span class="setting-range">(0.0 - 1.0)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-tfs-z" min="0" max="1" step="0.05" value="1.0">
                <input type="number" id="setting-tfs-z-value" min="0" max="1" step="0.05" value="1.0">
              </div>
              <p class="setting-hint">Default: 1.0 (disabled) | Reduces probability of unlikely tokens</p>
            </div>

            <!-- Num GPU -->
            <div class="setting-item">
              <label for="setting-num-gpu" title="Number of layers to offload to GPU. -1 = all">
                GPU Layers
                <span class="setting-range">(-1 - 999)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-num-gpu" min="-1" max="999" step="1" value="-1">
                <input type="number" id="setting-num-gpu-value" min="-1" max="999" step="1" value="-1">
              </div>
              <p class="setting-hint">Default: -1 (all) | 0 = CPU only</p>
            </div>

            <!-- Num Thread -->
            <div class="setting-item">
              <label for="setting-num-thread" title="Number of CPU threads. 0 = auto-detect">
                CPU Threads
                <span class="setting-range">(0 - 128)</span>
              </label>
              <div class="setting-control">
                <input type="range" id="setting-num-thread" min="0" max="128" step="1" value="0">
                <input type="number" id="setting-num-thread-value" min="0" max="128" step="1" value="0">
              </div>
              <p class="setting-hint">Default: 0 (auto) | Set based on your CPU cores</p>
            </div>

            <!-- Keep Alive -->
            <div class="setting-item">
              <label for="setting-keep-alive" title="How long to keep the model loaded in memory after request">
                Keep Alive
                <span class="setting-range">(minutes)</span>
              </label>
              <div class="setting-control">
                <select id="setting-keep-alive">
                  <option value="0">0 - Unload immediately</option>
                  <option value="1">1 minute</option>
                  <option value="5" selected>5 minutes (default)</option>
                  <option value="10">10 minutes</option>
                  <option value="30">30 minutes</option>
                  <option value="60">1 hour</option>
                  <option value="-1">Forever (until manual unload)</option>
                </select>
              </div>
              <p class="setting-hint">Default: 5m | How long model stays in memory between requests</p>
            </div>
          </div>

          <div class="settings-actions">
            <button id="reset-settings-btn" class="btn btn-secondary">Restore to Defaults</button>
            <button id="apply-settings-btn" class="btn btn-primary">Apply Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Help & Model Installation</h2>
          <button class="modal-close" id="close-help-modal">&times;</button>
        </div>
        <div class="modal-body">
          <h3>Installing Models</h3>
          <p>To use LocalLM Agent, you need to have models installed via Ollama.</p>
          
          <h4>üìã Model Name Reference</h4>
          <p class="help-note">Display names shown in the app vs actual Ollama model names:</p>
          <table class="model-table model-reference-table">
            <thead>
              <tr>
                <th>Display Name</th>
                <th>Actual Model</th>
                <th>Install Command</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Felix 2</td>
                <td><code>qwen3:14b</code></td>
                <td><code>ollama pull qwen3:14b</code></td>
              </tr>
              <tr>
                <td>Felix 2 mini</td>
                <td><code>qwen3:8b</code></td>
                <td><code>ollama pull qwen3:8b</code></td>
              </tr>
              <tr>
                <td>Felix 2.5</td>
                <td><code>deepseek-r1:14b</code></td>
                <td><code>ollama pull deepseek-r1:14b</code></td>
              </tr>
              <tr>
                <td>m1</td>
                <td><code>gemma3:12b</code></td>
                <td><code>ollama pull gemma3:12b</code></td>
              </tr>
              <tr>
                <td>Alyx 1e</td>
                <td><code>mannix/llama3.1-8b-abliterated:latest</code></td>
                <td><code>ollama pull mannix/llama3.1-8b-abliterated:latest</code></td>
              </tr>
              <tr>
                <td>Alyx 2</td>
                <td><code>cognitivecomputations/dolphin-mistral-nemo:latest</code></td>
                <td><code>ollama pull cognitivecomputations/dolphin-mistral-nemo:latest</code></td>
              </tr>
            </tbody>
          </table>

          <h4>Steps to Install</h4>
          <ol>
            <li>Open a terminal (PowerShell, CMD, or Terminal)</li>
            <li>Run the pull command for your desired model</li>
            <li>Wait for the download to complete</li>
            <li>Click "Refresh Models" in the app or restart</li>
          </ol>

          <h4>Managing Models</h4>
          <ul>
            <li><code>ollama list</code> - View installed models</li>
            <li><code>ollama rm &lt;model&gt;</code> - Remove a model</li>
            <li><code>ollama show &lt;model&gt;</code> - View model details</li>
          </ul>

          <h4>Keyboard Shortcuts</h4>
          <ul>
            <li><kbd>Enter</kbd> - Send message</li>
            <li><kbd>Shift + Enter</kbd> - New line</li>
            <li><kbd>Ctrl + N</kbd> - New chat</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Chat Modal -->
  <div id="rename-modal" class="modal" style="display: none;">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h3>Rename Chat</h3>
        <button class="modal-close" id="close-rename-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="rename-input">Chat name:</label>
          <input type="text" id="rename-input" class="form-input" placeholder="Enter new name...">
        </div>
        <div class="modal-actions">
          <button id="rename-cancel-btn" class="btn btn-secondary">Cancel</button>
          <button id="rename-confirm-btn" class="btn btn-primary">Rename</button>
        </div>
      </div>
    </div>
  </div>

  <script src="renderer.js"></script>
</body>
</html>
